\documentclass[11pt]{article}
\usepackage[a4paper,margin=25mm]{geometry}
\usepackage{fontspec}
{% set default_body_font = "Latin Modern Roman" %}
{% set body_font = metadata.body_font | default(default_body_font, true) %}
{% set body_font_candidates = namespace(values=[]) %}
{% for candidate in [
  body_font,
  "Latin Modern Roman",
  "TeX Gyre Termes",
  "TeX Gyre Pagella",
  "TeX Gyre Heros",
  "Times New Roman",
  "Times",
  "Helvetica Neue",
  "Helvetica",
  "Arial",
  "Arial Unicode MS"
] %}
  {% if candidate %}
    {% set value = candidate | string | trim %}
    {% if value and value not in body_font_candidates.values %}
      {% set _ = body_font_candidates.values.append(value) %}
    {% endif %}
  {% endif %}
{% endfor %}

{% set title_font_candidate = metadata.title_font | default(body_font, true) %}
{% set title_font_candidates = namespace(values=[]) %}
{% for candidate in [
  title_font_candidate,
  body_font,
  default_body_font,
  "TeX Gyre Termes",
  "TeX Gyre Pagella",
  "Montserrat",
  "Helvetica Neue",
  "Helvetica",
  "Arial",
  "Arial Unicode MS",
  "Times New Roman",
  "Times"
] %}
  {% if candidate %}
    {% set value = candidate | string | trim %}
    {% if value and value not in title_font_candidates.values %}
      {% set _ = title_font_candidates.values.append(value) %}
    {% endif %}
  {% endif %}
{% endfor %}

{% macro font_fallback(fonts, command_template, warning=None, fallback_command='') -%}
{% set sanitized = namespace(items=[]) %}
{% for font in fonts %}
  {% if font %}
    {% set cleaned = font | string | trim %}
    {% if cleaned %}
      {% set escaped = cleaned | latex_escape %}
      {% if escaped not in sanitized.items %}
        {% set _ = sanitized.items.append(escaped) %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}
{% set count = sanitized.items | length %}
{% if count > 0 %}
{% for font in sanitized.items %}
\IfFontExistsTF{ {{ font }} }{
  {{ command_template | replace('__FONT__', font) }}
}{
{% endfor %}
  {% if warning %}
  \PackageWarning{markdownpdf}{ {{ warning | latex_escape }} }
  {% endif %}
  {{ fallback_command }}
{% for _ in range(count) %}
}
{% endfor %}
{% else %}
  {% if warning %}
  \PackageWarning{markdownpdf}{ {{ warning | latex_escape }} }
  {% endif %}
  {{ fallback_command }}
{% endif %}
{%- endmacro %}

\providecommand{\MarkdownPDFMainFontName}{Latin Modern Roman}
{{ font_fallback(
  body_font_candidates.values,
  '\\setmainfont{__FONT__}\\renewcommand{\\MarkdownPDFMainFontName}{__FONT__}',
  'Aucune police principale candidate ne peut etre chargee; utilisation des reglages par defaut.'
) }}

{{ font_fallback(
  title_font_candidates.values,
  '\\newfontfamily\\MarkdownPDFTitleFont{__FONT__}',
  'Aucune police de titre candidate ne peut etre chargee; utilisation de la famille par defaut.',
  '\\newcommand{\\MarkdownPDFTitleFont}{\\rmfamily}'
) }}
\usepackage{graphicx}
\usepackage{float}
\floatplacement{figure}{H}
\floatplacement{table}{H}
\usepackage{babel}
\usepackage[autostyle=true]{csquotes}
\usepackage{hyperref}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{xcolor}
\usepackage{setspace}
\usepackage{listings}
\usepackage{amssymb}
\usepackage{longtable,booktabs,array}
\usepackage{calc}
\usepackage{etoolbox}
\usepackage{enumitem}
\usepackage{colortbl}
\usepackage{sectsty}
{% set raw_title_color = metadata.title_color | default("#1A1A1A", true) %}
{% if "#" in raw_title_color %}
\definecolor{MarkdownPDFTitleColor}{HTML}{ {{- raw_title_color.replace('#', '') | upper -}} }
{% else %}
\colorlet{MarkdownPDFTitleColor}{ {{- raw_title_color | latex_escape -}} }
{% endif %}
\definecolor{MarkdownPDFLinkColor}{HTML}{1A6FB3}

\sectionfont{\color{MarkdownPDFTitleColor}\MarkdownPDFTitleFont}
\subsectionfont{\color{MarkdownPDFTitleColor}\MarkdownPDFTitleFont}
\subsubsectionfont{\color{MarkdownPDFTitleColor}\MarkdownPDFTitleFont}

{% raw %}
\providecommand{\passthrough}[1]{#1}
{% endraw %}
{% raw %}
\providecommand{\pandocbounded}[2][]{#2}
{% endraw %}
\lstset{
  basicstyle=\ttfamily\small,
  breaklines=true,
  columns=fullflexible,
  frame=single,
  framerule=0pt,
  backgroundcolor=\color[gray]{0.95},
  showstringspaces=false
}

\providecommand{\tightlist}{
  \setlength{\itemsep}{0pt}
  \setlength{\parskip}{0pt}
}

\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\makeatletter
\def\fps@figure{htbp}
\makeatother

\setlist[itemize]{leftmargin=*, labelsep=0.5em}
\setlist[enumerate]{leftmargin=*, labelsep=0.5em}
\setlist[description]{leftmargin=*, labelsep=0.5em}

\definecolor{MarkdownPDFTableAltRow}{HTML}{FAFBFD}
\definecolor{MarkdownPDFTableRule}{HTML}{D6DFEB}

\setlength{\tabcolsep}{6pt}
\renewcommand{\arraystretch}{1.15}
\setlength{\LTleft}{\fill}
\setlength{\LTright}{\fill}

\newcommand{\MarkdownPDFSetupTable}{
  \rowcolors{2}{MarkdownPDFTableAltRow}{white}% alterner sur les lignes de données, en laissant l'entête intacte
  \arrayrulecolor{MarkdownPDFTableRule}
}

\AtBeginEnvironment{longtable}{
  \MarkdownPDFSetupTable
}

\AfterEndEnvironment{longtable}{
  \rowcolors{2}{white}{white}% réinitialiser pour les tableaux suivants
  \arrayrulecolor{black}
}

% Longtable fixes inspired by Pandoc's default template
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}

\setlength{\emergencystretch}{2em}

\pagestyle{fancy}
\fancyhf{}

\hypersetup{
  colorlinks=true,
  linkcolor=MarkdownPDFLinkColor,
  urlcolor=MarkdownPDFLinkColor,
  citecolor=MarkdownPDFLinkColor,
  pdfborder={0 0 0}
}

% Header configuration
\fancyhead[L]{\ignorespaces
  \begin{minipage}[c]{0.6\textwidth}%
  \raggedright
  {\Large \textcolor{MarkdownPDFTitleColor}{\MarkdownPDFTitleFont {{ metadata.title | default(metadata.company, true) | latex_escape }}}}\\
  {\small {{ metadata.author | latex_escape | default("", true) }}}%
  \end{minipage}%
}
\fancyhead[R]{\ignorespaces
  \begin{minipage}[c]{0.35\textwidth}%
  \raggedleft
  {\small {{ metadata.contact | latex_escape | default("", true) }}}%
  \end{minipage}%
}

% Footer configuration
\fancyfoot[L]{\small {{ metadata.address | latex_escape | default("", true) }}}
\fancyfoot[R]{\small Page \thepage{} / \pageref{LastPage}}

{% if preamble %}
% Extra preamble
{{ preamble }}
{% endif %}

\setlength{\headheight}{32pt}
\setlength{\parskip}{0.8em}
\setlength{\parindent}{0pt}

\begin{document}

\onehalfspacing

{% set cover_enabled = show_cover | default(true) %}
{% set toc_enabled = show_toc | default(true) %}
{% set toc_present = toc_entries and toc_enabled %}

{% if cover_enabled or toc_present %}
\pagenumbering{gobble}
{% endif %}

{% if cover_enabled %}
{% include 'cover.tex.j2' %}
\clearpage
{% endif %}

{% if toc_present %}
\thispagestyle{empty}
{% include 'toc.tex.j2' %}
\clearpage
{% endif %}

\pagenumbering{arabic}
\setcounter{page}{1}
\pagestyle{fancy}

{{ body | safe }}

\end{document}
